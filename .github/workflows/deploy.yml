name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/relief-connect-map:latest

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -x
            
            echo "==== Pulling new image ===="
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/relief-connect-map:latest || {
              echo "Failed to pull image"
              exit 1
            }
            
            echo "==== Cleaning up existing container ===="
            docker stop relief-connect-map || true
            docker rm relief-connect-map || true
            
            echo "==== Starting new container ===="
            docker run -d \
              --name relief-connect-map \
              -p 5000:8000 \
              -e DB_HOST="${{ secrets.DB_HOST }}" \
              -e DB_PORT="${{ secrets.DB_PORT }}" \
              -e DB_NAME="${{ secrets.DB_NAME }}" \
              -e DB_USER="${{ secrets.DB_USER }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              --network airflow-setup_default \
              ${{ secrets.DOCKERHUB_USERNAME }}/relief-connect-map:latest
            
            echo "==== Verifying container ===="
            docker ps -a
            
            echo "==== Container logs ===="
            docker logs relief-connect-map || echo "Failed to get logs"
            
            echo "==== Checking container status ===="
            if ! docker ps | grep -q relief-connect-map; then
              echo "Container is not running"
              exit 1
            fi
            
            echo "==== Cleaning up unused images ===="
            docker image prune -f
            
            echo "==== Deployment complete ===="

